import e from"http";import t from"@/utils/Logger/concollor";var r,s={},n={};Object.defineProperty(n,"__esModule",{value:!0}),function(e){e[e.STATIC=0]="STATIC",e[e.PARAM=1]="PARAM"}(r||(r={}));const i=":",o="/".charCodeAt(0);class h{constructor(e={}){this.indices=e.indices||"",this.children=e.children||[],this.childrenI=e.childrenI||{},this.path=e.path||"",this.handle=e.handle||null,this.wildChild=e.wildChild||!1,this.type=e.type||r.STATIC,this.param=e.param||"",this.pathLength=this.path.length,this.childrenLength=this.children.length}addRoute(e,t){const r=this.countParams(e);this.isEmpty()?this.insertChild(e,e,t,r):this.onChunk(this,e,e,t,r)}search(e){let t=this;const r={};e:for(;;){const s=e.length;if(s>t.pathLength&&e.slice(0,t.pathLength)===t.path){if(e=e.slice(t.pathLength),t.wildChild){t=t.children[0];let n=0;for(;n<s&&e.charCodeAt(n)!==o;)n++;const i=e.slice(0,n);if(!i||!t.param)return{value:null,params:r};if("!"!==t.param&&(r[t.param]=i),n<s){if(0===t.childrenLength)return{value:null,params:r};e=e.slice(n),t=t.children[0];continue e}return{value:t.handle,params:r}}const n=e.charCodeAt(0);for(let e=0;e<t.indices.length;e++)if(n===t.indices.charCodeAt(e)){t=t.children[e];continue e}}else if(e===t.path)return{value:t.handle,params:r};return{value:null,params:r}}}hasChildren(){return this.children.length>0}insertChild(e,t,s,n){let o=0,h=this;for(let s=0,a=t.length;n>0;s++){if(t[s]!==i)continue;let l=s+1;for(;l<a&&"/"!==t[l];){if(t[l]===i)throw new Error("only one wildcard per path segment is allowed, has: '"+t.slice(s)+"' in path '"+e+"'");l++}if(h.hasChildren())throw new Error("wildcard route '"+t.slice(s,l)+"' conflicts with existing children in path '"+e+"'");if(l-s<2)throw new Error("wildcards must be named with a non-empty name in path '"+e+"'");s>0&&(h.replacePath(t.slice(o,s)),o=s),h=h.replaceChildren({type:r.PARAM}),n--,l<a&&(h.replacePath(t.slice(o,l)),o=l,h=h.replaceChildren())}h.replacePath(t.slice(o)),h.setHandle(s)}setHandle(e){this.handle=e}replaceChildren(e={}){const t=new h(e);return e.type===r.PARAM&&(this.wildChild=!0),this.children=[t],this.childrenLength=1,t}replacePath(e){e[0]===i&&(this.param=e.slice(1)),this.path=e,this.pathLength=e.length}isEmpty(){return!(this.path.length>0||this.children.length>0)}processCharacter(e,t,s,n){const o=t[0];if(this.type===r.PARAM&&"/"===o&&1===this.children.length)return void this.onChunk(this.children[0],e,t,s,n);const a=this.childrenI[o.charCodeAt(0)];if(a)a.onChunk(a,e,t,s,n);else{if(o!==i){const i=new h({type:r.STATIC});return this.children.push(i),this.indices+=o,this.childrenI[o.charCodeAt(0)]=i,this.childrenLength=this.children.length,void i.insertChild(e,t,s,n)}this.insertChild(e,t,s,n)}}processWildcard(e,t,r,s){if(t.length>=this.path.length&&this.path===t.slice(0,this.path.length)&&(this.path.length>=t.length||"/"===t[this.path.length]))return void this.onChunk(this,e,t,r,s);const n=t.split("/")[0],i=e.slice(0,e.indexOf(n))+this.path;throw new Error(`'${n}' in new path '${e}' conflicts with existing wildcard '${this.path}' in existing prefix '${i}'`)}createNode(e,t,r,s,n){const i=r.slice(e);this.wildChild?this.children[0].processWildcard(t,i,s,n-1):this.processCharacter(t,i,s,n)}commonPrefixIndex(e){let t=0;const r=Math.min(e.length,this.path.length);for(;t<r&&this.path[t]===e[t];)t++;return t}split(e,t){if(e<this.path.length){const r=new h({path:this.path.slice(e),wildChild:this.wildChild,childrenI:this.childrenI,children:this.children,handle:this.handle,indices:this.indices});return this.children=[r],this.indices=this.path[e],this.childrenI={[this.indices.charCodeAt(0)]:r},this.childrenLength=1,this.wildChild=!1,this.path=t.slice(0,e),this.pathLength=this.path.length,this.handle=null,!0}return!1}onChunk(e,t,r,s,n){const i=e.commonPrefixIndex(r),o=e.split(i,r);if(i<r.length)e.createNode(i,t,r,s,n);else if(i===r.length){if(!o)throw new Error("Route already defined.");this.handle=s}}countParams(e){let t=0;for(let r=0;r<e.length;r++)e[r]===i&&t++;return t}}n.Node=h,Object.defineProperty(s,"__esModule",{value:!0});const a=n;function l(e,t){if(!t)throw new Error("Path is required.");if(!e)throw new Error("Bucket is required.");if("string"!=typeof e)throw new Error("Bucket should be a string.");if("string"!=typeof t)throw new Error("Path should be a string.")}var d=s.RoadRunner=class{constructor(){this.buckets={}}addRoute(e,t,r){if(l(e,t),"/"!==t[0]&&"*"!==t[0])throw new Error("The first character of a path should be `/` or `*`.");t=t.replace(/\*([A-z0-9]+)?\//g,":!/").replace(/\*$/g,":!"),this.buckets[e]||(this.buckets[e]=new a.Node),this.buckets[e].addRoute(t,r)}findRoute(e,t){if(l(e,t),!this.buckets[e])return null;const r=this.buckets[e].search(t);return null===r.value?null:{value:r.value,params:r.params}}};const c={b:1,f:2,i:3,u:4,l:5,h:6,n:7,c:8,s:9},u=["black","red","green","yellow","blue","magenta","cyan","white","crimson"];function p(e,t){return e?`[${e}m${t}[0m`:t}function f(e,t){for(const r of e.split(","))if(1===r.length)t=p(c[r],t);else{const[e,s]=r.split("/"),n=u.indexOf(e),i=u.indexOf(s);n>-1&&(t=p(30+n,t)),i>-1&&(t=p(40+i,t))}return t}function m(e){return(t,...r)=>{if("string"==typeof t)return f(e,t);const s=[t[0]];let n=1;for(const e of r){const r=t[n++];s.push(String(e),r)}return f(e,s.join(""))}}module.exports=f,module.exports=m;const g={titleTag:m("b,i,red/red"),messageTag:m("red/red"),defaultTitle:"Error"},w={titleTag:m("b,i,yellow/yellow"),messageTag:m("yellow/yellow"),defaultTitle:"Warn"},C={titleTag:m("b,blue"),messageTag:m("blue"),defaultTitle:"Info"},T={titleTag:m("b,green"),messageTag:m("green"),defaultTitle:"Success"},v={titleTag:m("b,cyan"),messageTag:m("cyan"),defaultTitle:"Put"},E={titleTag:m("b,crimson"),messageTag:m("crimson"),defaultTitle:"Patch"},A={titleTag:m("b,magenta"),messageTag:m("magenta"),defaultTitle:"Data"},N=/(https?:\/\/\S+)/gm;function b(e){const r=String(e);console.log(r.replace(N,(e=>t`${e}(u,blue)`)))}function S({titleTag:e,messageTag:t,defaultTitle:r}){return function(s,n){console.log(e(`${n??r}: `)+t(`${s}`))}}var y;function I(e,t){const r=`The request method: ${e.method} is not supported by the server and cannot be handled`;b.error(r,`Error ${y.NotImplemented}`),t.statusCode=y.NotImplemented,t.statusMessage=r,t.end()}function P(e,t,r){b.error("Unexpected Server Error",`Error ${y.InternalServerError}`),b.error(r.message),t.statusCode=y.InternalServerError,t.statusMessage="Internal Server Error",t.end()}function x(e,t){const r=`The request ${e.method} ${e.url} is not allowed`;t.statusCode=y.MethodNotAllowed,t.statusMessage=r,t.end()}function M(e,t){const r=`The request ${e.method} ${e.url} is not found`;t.statusCode=y.NotFound,t.statusMessage=r,t.end()}function $(e){let t=e;for(;t.startsWith("/");)t=t.slice(1);for(;t.endsWith("/");)t=t.slice(0,-1);return"/"+t}function R(e,t){const r=e??"",s=t??"";if(r.includes(":"))throw new Error("cant has semicolon");if(s.includes("*"))throw new Error("cant has semicolon");const n=[],i=s.split("/").reduce(((e,t)=>{if(t.includes(":")){const r=t.slice(1);if(!function(e){if(e.trim()!==e)return!1;try{new Function(e,"var "+e)}catch(e){return!1}return!0}(r))throw new Error(`invalid var name: ${r}`);return n.push(t.slice(1)),e+"/"+t}return e+"/"+t}),""),o=$(r);return{pathName:$(o+$(i)),prefix:o,props:n}}b.error=S(g),b.warn=S(w),b.info=S(C),b.success=S(T),b.put=S(v),b.patch=S(E),b.data=S(A),module.exports=b,function(e){e[e.Ok=200]="Ok",e[e.Created=201]="Created",e[e.Accepted=202]="Accepted",e[e.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",e[e.NoContent=204]="NoContent",e[e.ResetContent=205]="ResetContent",e[e.PartialContent=206]="PartialContent",e[e.MultiStatus=207]="MultiStatus",e[e.AlreadyReported=208]="AlreadyReported",e[e.IMUsed=226]="IMUsed",e[e.BadRequest=400]="BadRequest",e[e.NotFound=404]="NotFound",e[e.MethodNotAllowed=405]="MethodNotAllowed",e[e.InternalServerError=500]="InternalServerError",e[e.NotImplemented=501]="NotImplemented"}(y||(y={})),module.exports=I,module.exports=P,module.exports=x,module.exports=M;class k{static ServerError=P;static NotFound=M;static MethodNotAllowed=x;static NotImplemented=I;static router=new d;static routeHandlers={GET:{},HEAD:{},POST:{},PUT:{},DELETE:{},CONNECTS:{},OPTIONS:{},TRACE:{},PATCH:{},ServerError:k.ServerError,NotFound:k.NotFound,MethodNotAllowed:k.MethodNotAllowed,NotImplemented:k.NotImplemented};static addRoute(e,{method:t,prefix:r,path:s}){const{pathName:n}=R(r,s);switch(t){case"GET":b.info(n,t);break;case"POST":b.warn(n,t);break;case"DELETE":b.error(n,t);break;case"PATCH":b.patch(n,t);break;case"PUT":b.put(n,t);break;default:b.data(n,t)}k.router.addRoute(t,n,e)}getRequestHandler(e){if(e.method){const t=k.router.findRoute(e.method,e.url);return t?{handler:t.value,params:t.params}:{handler:k.routeHandlers.NotFound}}return{handler:k.routeHandlers.NotImplemented}}}module.exports=k;class L{static middlewares=[];static asyncMiddlewares=[];runMiddlewaresSync(e,t){const r=e=>{if(e instanceof Error)throw t=e.message,r="Middleware",b.error(t,`Middleware Error in ${r}`),new Error(t);var t,r};for(const s of L.middlewares)s(e,t,r)}static use(e){L.middlewares.push(e)}}module.exports=L;class O{server;middleware;router;host;port;constructor(){this.requestListener=this.requestListener.bind(this),this.middleware=new L,this.router=new k,this.server=e.createServer(this.requestListener),this.host=process.env.HOST||"localhost",this.port=Number(process.env.PORT)||3e3}requestListener(e,t){try{this.middleware.runMiddlewaresSync(e,t);const{handler:r,params:s}=this.router.getRequestHandler(e);r(e,t,s)}catch(r){k.routeHandlers.ServerError(e,t,r)}}run(){this.server.on("error",(e=>{"EACCES"===e.code&&b.error(`No access to port: ${this.port}`,"EACCES")})),this.server.listen(this.port,(()=>{b.success(`Server is running at http://${this.host}:${this.port}`)})),process.on("exit",(()=>{this.server.close((()=>{b.warn(`Server is closed at http://${this.host}:${this.port}`)}))})),process.on("exit",(()=>{this.server.close((()=>{b.warn(`Server is closed at http://${this.host}:${this.port}`)}))}))}}module.exports=O;export{O as default};
//# sourceMappingURL=index.js.map
